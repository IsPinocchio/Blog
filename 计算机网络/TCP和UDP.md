## 一. TCP协议

TCP是一个**面向连接的**、**可靠的**、**基于字节流**的传输层协议。

### 1.1 三大特性：

* **面向连接**：指的是客户端和服务器在通信之前，需要三次握手建立连接
* **可靠性**：TCP会精准记录`哪些数据发送了`，`哪些数据被接收了`，`哪些数据没有被接收`,保证数据报按序到达，且会根据网络情况调整自己的行为（比如：控制发送速度或者重发）
* **基于字节流**：TCP为了维护状态，将一个个IP包变成了字节流。

### 1.2 tcp三次握手概况

**第一次握手：**客户端向服务器发送一个 SYN 连接请求报文段，报文段的首部中 SYN 标志位置为 1，序号字段是一个任选的 随机数。它代表的是客户端数据的初始序号。

**第二次握手：**服务器端接收到客户端发送的 SYN 连接请求报文段后，服务器首先会为该连接分配 TCP 缓存和变量，然后向 客户端发送 SYN ACK 报文段，报文段的首部中SYN 和 ACK 标志位都被置为 1，代表这是一个对 SYN 连接请求的确认， 同时序号字段是服器端产生的一个任选的随机数，它代表的是服务器端数据的初始序号。确认号字段为客户端发送的序号加 一。

**第三次握手：**客户端接收到服务器的肯定应答后，它也会为这次 TCP 连接分配缓存和变量，同时向服务器端发送一个对服务 器端的报文段的确认。第三次握手可以在报文段中携带数据。

> **为什么要三次握手呢？**
>
> 首先要确认双发都既有发送能力也有接受能力，再一主要是防止已经失效的连接请求报文突然又传送到了服务器导致再次建立连接造成资源浪费。
>
> `比如`：客户端第一次发出的请求连接在网络中发生滞留，由于迟迟没有收到服务端的确认，因此又发了一遍请求并成功建立了连接。当传输完数据并关闭连接后，第一次滞留的请求达到了服务端，那么两次握手的机制就会让客户端和服务端再次建立连接，导致资源浪费。如果是三次握手，服务端接受了滞留的请求并回复确认报文，但客户端是不会再次确认的，由于服务端收不到确认，就无法建立连接。

### 1.3 tcp四次挥手

客户端发送FIN包申请关闭连接，此时A进入`FIN-WAIT-1`状态，不会再向B端发送数据包。

服务端接收到FIN包后会立即回复ACK包，此时B进行`CLOSE-WAIT`状态。

客户端接收到服务端传输的ACK确认包后会将其状态修改为`FIN-WAIT-2`

服务端检查自身是否还有数据需要发送，如果有将会发送完所有未发送数据，若无则发送FIN包进入`LAST-ACK`状态

客户端接收到服务端的FIN包后会发送ACK包，进入`TIME-WAIT`状态等待

服务端收到客户端传输的ACK确认包后将会直接释放连接进入`CLOSED`状态

等待2个MSL(`Maximum Segment Lifetime，报文最大生存时间`)后客户端释放链接，进入`关闭`状态

> 最后一次挥手中，客户端会等待2个MSL再关闭的原因，是为了**防止发送给服务器的确认报文段丢失或者出错，从而导致服务器端不能正常关闭**。
>

> **为什么是四次挥手不是三次？**
>
> 因为TCP的连接时全双工的，需要双方分别释放到对方的连接。
>
> 一方收到对方的FIN报文时，仅代表对方不再发送数据但是还能接受数据。
>
> `那为什么第二次发送ACK和第三次发送FIN不在一起发送呢？`因为服务端后续可能还需要发送一些数据，等所有数据发送完了，再发送FIN报文给对方来表示关闭连接更合适一些，所以导致多了一次握手。

### 1.4 建立连接后，客户端突然出现故障怎么办

TCP设有一个`保活计时器`。当客户端故障后，服务器不能一直等下去，这样会浪费资源。因此服务端每收到一次客户端的请求就会重新复位这个计时器（通常是2个小时），如果这个时间段后没有收到客户端任何数据，服务端就会发送一个探测报文段，每个75秒发送一次。若连发10个探测报文仍没反应，服务端就认为客户端出现了故障，就会关闭连接。

### tcp和udp的区别

1. TCP是面向连接的，UDP是无连接的
2. TCP连接传送的数据无差错、不丢失（**基于连续 ARQ 协议和滑动窗口协议**）；UDP不保证可靠交付
3. TCP面向字节流，UDP面向报文
4. TCP只能1对1的，UDP支持1对1，1对多
5. TCP的首部为20字节，UDP只有8字节



