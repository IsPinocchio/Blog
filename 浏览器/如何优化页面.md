# 页面性能：如何系统地优化页面？



通常一个页面有三个阶段：**加载阶段**、**交互阶段**、**关闭阶段**

* **加载阶段**是指从发出请求到渲染出完整页面的过程，主要影响因素有网络和JavaScript脚本
* **交互阶段**是指从页面加载完成到用户交互的整合过程，主要影响因素是JavaScript脚本
* **关闭阶段**是指用户发出关闭指令后页面所做的一些清理操作



### 加载阶段

![加载阶段流水线](D:\沸点前端\浏览器\img\加载阶段流水线.png)

把能阻塞网页首次渲染的资源成为**关键资源**，基于关键资源，可继续细化出三个影响页面首次渲染的核心因素：

* **关键资源个数**

* **关键资源大小**

* **请求关键资源需要多少个RTT**

  * `RTT 就是这里的往返时延。它是网络中一个重要的性能指标，表示从发送端发送数据开始，到发送端收到来自接收端的确认，总共经历的时延`。通常 1 个 HTTP 的数据包在 14KB 左右，所

    以 1 个 0.1M 的页面就需要拆分成 8 个包来传输了，也就是说需要 8 个 RTT。



### 交互阶段

谈交互阶段的优化其实就是在谈`渲染进程渲染帧的速度`，因为交互阶段，帧的渲染速度决定了交互的流畅度。

![渲染进程](D:\沸点前端\浏览器\img\渲染进程.png)

* 如果在计算样式阶段发现有布局信息的修改，那么就会触发**重排**操作，然后触发后续渲染流水线的一系列操作。这个代价很大！
* 如果在计算样式阶段没有发现有布局信息的修改，只是修改了颜色一类的信息，那么就不会涉及到布局相关的调整，所以可以跳过布局阶段，直接进入绘制阶段，这个过程叫**重绘**。不过重绘阶段的代价也是不小的。
* 通过 CSS 实现一些变形、渐变、动画等特效，这是由 CSS 触发的，并且是在合成线程上执行的，这个过程称为**合成**。因为它不会触发重排或者重绘，而且合成操作本身的速度就非常快，所以执行合成是效率最高的方式。
* **减少JavaScript脚本执行时间**，JavaScript函数一次执行时间可能有几百毫秒，这就严重霸占了主线程执行其他渲染任务的时间
  * 一次执行的函数分解为多个任务，使得每次的执行时间不要过久
  * 采用web workers，可以把web workers当作主线程之外的一个线程，web worker可以执行JavaScript脚本，不过web workers中没有DOM和CSSOM环境
* **避免强制同步布局**，所谓强制同步布局，是指JavaScript强制将计算样式和布局操作提前到当前的任务中（一般来说，通过DOM添加或删除元素，是需要重新计算样式和布局的，不过正常情况下这些操作都是在另外的任务中异步完成的，这样是为了避免当前的任务占用太长的主线程时间）
* **避免布局抖动**所谓布局抖动是指一次JavaScript执行过程中，多次执行强制布局和抖动操作。
* **合理利用css合成动画**，合成动画是直接在合成线程上执行的。如果提前知道对某个元素执行动画操作，那就最好将其标记机为will-change。
* **避免频发的垃圾回收**







