# 为什么XMLHttpRequest不能跨域请求资源？

如果页面没有安全策略的话，Web世界会是什么样子？



Web世界会是开放的，任何资源都可以接入期中，我们的网站可以加载并执行别人网站的脚本、图片、音频等资源。但比如，你打开了一个银行站点，又不小心打开一个恶意站点，在没有安全措施下，恶意站点就可以做很多事情。比如：在银行站点内部插入JavaScript脚本，修改银行站点的DOM、CSSOM等、劫持用户登录的用户名和密码、Cookie等数据。



所以说，在没有安全保障的Web世界中，我们是没有隐私的，因此需要安全策略来保障我们的隐私和数据的安全。

由此引出了页面最基础、最核心的安全策略：**同源策略（Same-Origin policy）**



### 一. 同源策略

> 如果两个URL的协议、域名和端口都相同，我们就称这两个URL**同源**。

浏览器默认两个相同的源之间是可以相互访问资源和操作 DOM 的。两个不同的源之间若想要相互访问资源或者操作 DOM，那么会有一套基础的安全策略的制约，我们把这称为**同源策略**。



一般来讲，同源策略主要表现在DOM、Web数据和网络这三个层面。

* **DOM层面**：同源策略限制了来自不同源的JavaScript脚本对当前DOM对象读和写的操作。
* **数据层面**：同源策略限制了不同源的站点读取当前站点的Cookie、IndexDB、LocalStorage等数据。
* **网络层面**：同源策略限制了通过XMLHttpRequest、Fetch等方式将站点的数据发送给不同源的站点。

### 二. 安全和便利性的权衡

不同源之间绝对隔离的话无疑是最安全的措施，但这也会使得Web项目难以开发和使用。因此我们要做出权衡，在同源策略中让出一些安全性来满足灵活性。那么，同源策略让出了哪些安全性呢？

#### 2.1 页面中可以嵌入第三方资源

也就是比如在HTML文件中插入`<script src=""></script>`代码。

但遇到最多的问题就是浏览器首页内容会被一些恶意程序劫持，然后往HTML文本中插入恶意脚本。除此之外，它还能将页面的敏感数据通过XSS手段发送给服务器。

为了解决XSS攻击，浏览器中引入了**内容安全策略**，称为**CSP**。CSP的核心思想是让服务器决定浏览器能够加载哪些资源，让服务器决定浏览器是否能够执行内联JavaScript代码。这样就可以大大减少XSS攻击。

#### 2.2 跨域资源共享

由于受同源策略影响禁止向其他源发送请求，这大大制约了我们的生产力。为了解决这个问题，我们引入**跨域资源共享（CORS）**，该机制可以进行跨域访问控制，从而使得跨域数据传输得以安全进行。

#### 2.3 跨文档消息机制

介绍同源策略时提到，不同源的页面无法相互操作DOM。但在实际操作中，经常需要两个不同源的DOM之间进行通信，于是浏览器中引入了**跨文档消息机制**。可以通过window.postMessage的JavaScript接口来和不同源的DOM进行通信。



