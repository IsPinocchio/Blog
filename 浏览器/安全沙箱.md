# 安全沙箱：页面和系统之间的隔离墙

单进程浏览器中如果存在漏洞，那么黑客就有可能通过恶意的页面向浏览器注入恶意程序。其中最常见的攻击方式是利用**缓冲区溢出**，不过需要注意这种类型的攻击和XSS注入的脚本是不一样的。

​		XSS攻击只是将恶意的JavaScript代码注入到页面，窃取Cookie相关的数据，对操作系统无法攻击。

​		而通过浏览器漏洞进行的攻击是可以入侵到浏览器进程内部的，可以读取和修改浏览器进程内部的任意内容，还可以穿透浏览器，在用户的操作系统上悄悄安装恶意软件等。

---------

现代浏览器的设计目标是**安全**、**快速**和**稳定**。而通过浏览器漏洞对操作系统进行攻击无疑是核弹级别的伤害。因此现代浏览器采用了多进程架构，将渲染进程和浏览器主进程做了分离，并将渲染进程放进沙箱中。

![浏览器内核和渲染进程](D:\沸点前端\浏览器\img\浏览器内核和渲染进程.png)

浏览器被划分为**浏览器内核**和**渲染内核**两个核心模块。跟操作系统打交道的地方基本都是在浏览器内核中进行。

### 安全沙箱

由于渲染进程需要执行DOM解析、CSS解析、网络图片解码等操作，如果渲染进程中存在系统级别的漏洞，那么以上操作就有可能让恶意的站点获取到渲染进程的控制权限，进而又获取操作系统的控制权限，这是非常危险的。

因此将渲染进程和操作系统隔离的这道墙就是我们所说的**安全沙箱**。



浏览器中的安全沙箱是利用操作系统提供的安全技术，让渲染进程在执行过程中无法访问或修改系统中的数据，在渲染进程需要访问系统资源时，需要通过浏览器内核来实现，然后将访问的结果通过IPC转发给渲染进程。

### 安全沙箱如何影响各个模块的功能

安全沙箱最小的保护单位是进程，并且能限制进程对操作系统资源的访问和修改。这就意味着要让安全沙箱应用在某个进程上，那么这个进程必须没有读写操作系统的功能，比如：读写本地文件、发起网络请求、调用GPU接口等。而是将这些功能放到浏览器内核当中。

* **持久存储**
  * 由于安全沙箱的存在，渲染进程无法访问文件系统，但在渲染进程内部有访问Cookie或上传文件等需求时，现代浏览器将读写文件的操作全部放在了浏览器内核中实现，然后通过IPC将结果转发给渲染进程。
* **网络访问**
  * 同样有了安全沙箱，渲染进程内部也不能直接访问网络，如果要访问网络，则要通过浏览器内核。
  * 浏览器内核在处理URL请求之前，会检查渲染进程是否有权限请求该URL，比如检查XMLHttpRequest或Fetch是否是跨站点请求等
* **用户交互**
  * 通常情况下，一个UI程序，操作系统会提供一个界面给你，该界面允许应用程序与用户交互。但由于安全沙箱导致渲染进程不能访问窗口句柄（可理解为操作系统提供的交互媒介），所以渲染进程需要完成以下两大点改变
    * 渲染进程渲染出位图，然后发送给浏览器内核，浏览器内核再和操作系统打交道将位图复制到屏幕上
    * 操作系统没有将用户输入事件直接传递给渲染进程，而是将这些事件传递给浏览器内核。浏览器内核再根据当前浏览器界面的状态来判断如何调度这些事件；如果当前焦点在浏览器地址栏中，则输入事件在浏览器内核中处理；如果当前焦点在页面内，则浏览器内核将输入事件转发给渲染进程。
* **站点隔离**（Site Isolation）
  * 所谓站点隔离指Chrome将同一站点（包含相同根域名和相同协议的地址）中相互关联的页面放到同一个渲染进程中执行。
  * 最开始，Chrome是以标签页为单位划分给某个渲染进程，但一个页面可能包含多个iframe，如果有一个iframe是恶意的，那么他就可以入侵渲染进程，拿到相关的页面数据了。
  * 因此后来Chrome重构代码，改为按照同一站点的策略来分配渲染进程。